# Copyright 2015 Nicolas Melot
#
# This file is part of Freja.
#
# Freja is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Freja is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Freja. If not, see <http://www.gnu.org/licenses/>.
#


#!/bin/bash

## Move into the right directory
cd `dirname $0`

echo This will install freja in your account.
echo The installation operations include:
echo '*' Place files for freja in $HOME/.freja
echo '*' Place a link to freja executable in $HOME/.local/bin
## Update the shell
case "`getent passwd $LOGNAME | cut -d: -f7 | rev | cut -f 1 -d '/' | rev`" in
	"bash")
		echo '*' Update $HOME/.bash_profile to add $HOME/.local/bin to \$PATH
		echo '*' Update $HOME/.bashrc to add $HOME/.local/bin to \$PATH
	;;
	"tcsh")
		echo '*' Update $HOME/.cshrc to add $HOME/.local/bin to \$PATH
	;;
	*)
		:
	;;
esac
echo Continue '(y/[n])'?
read proceed

shell_comment='## Add the local hierarchy ~/.local/bin (that contains freja executable) into $PATH'
shell_var=PATH
shell_val=$HOME/.local/bin

install_bash()
{
	## $1 is the file in which we want to output the additional commands
	filename="$1"

	## Backup $HOME/.bash_profile
	if [ -f "$filename" ]
	then
		echo Create backup for $filename in ${filename}.freja.$$.bak
		cp "$filename" "${filename}.freja.$$.bak"
	fi

	echo >> $filename
	echo $shell_comment >> $filename
	echo export $shell_var='$'"$shell_var:$shell_val" >> $filename
}

install_csh()
{
	## $1 is the file in which we want to output the additional commands
	filename="$1"

	## Backup $HOME/.schrc
	if [ -f "$filename" ]
	then
		echo Create backup for $filename in ${filename}.cshrc.freja.$$.bak
		cp $filename ${filename}.freja.$$.bak
	fi

	echo >> $filename
	echo $shell_comment >> $filename
	echo >> $filename
	echo 'if ($?'$shell_var') then' >> $filename
	echo '	setenv' $shell_var '${'"$shell_var}:$shell_val" >> $filename
	echo 'else' >> $filename
	echo '	setenv' "$shell_var $shell_val" >> $filename
	echo 'endif' >> $filename
}

if [ "$proceed" == "y" ]
then
	## Create directories, if needed
	mkdir -p $HOME/.local/bin
	mkdir -p $HOME/.freja

	## Copy freja's files
	cp freja/* $HOME/.freja
	if [ ! -f $HOME/.local/bin/freja ]
	then
		ln -s $HOME/.freja/freja $HOME/.local/bin/
	fi

	## Update the shell
	case "`getent passwd $LOGNAME | cut -d: -f7 | rev | cut -f 1 -d '/' | rev`" in
		"bash")
			install_bash $HOME/.bash_profile
			install_bash $HOME/.bashrc
		;;
		"tcsh")
			install_csh $HOME/.cshrc
		;;
		*)
			echo '[WARN]' Don"'"t know how to setup `getent passwd $LOGNAME | cut -d: -f7 | rev | cut -f 1 -d '/' | rev` to update $shell_var at startup.
		;;
	esac

	echo Installation done.
	echo
	echo End your session and login again to reflect the change.
else
	echo No change performed
fi
